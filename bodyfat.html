<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Grasa Corporal | HealthUp</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="site-header sticky-header">
        <div class="container header-inner">
            <a href="index.html" class="logo" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                <img src="img/logo.png" alt="HealthUp logo" style="height:38px;width:38px;vertical-align:middle;border-radius:8px;flex-shrink:0;">
                <div style="display:flex;flex-direction:column;line-height:1;">
                    <span style="font-weight:700;font-size:1.5rem;line-height:1;">HealthUp</span>
                    <span class="tagline" style="font-size:0.95rem;color:#7bed9f;line-height:1.2;">Tu salud, tu plan — simple y accesible</span>
                </div>
            </a>
            <nav class="main-nav" aria-label="Menú principal">
                <button class="nav-toggle" aria-label="Abrir menú">&#9776;</button>
                <ul>
                    <li><a href="about.html">Sobre Nosotros</a></li>
                    <li><a href="contact.html">Contacto</a></li>
                    <li><a href="meal-plans.html">Planes</a></li>
                    <li><a href="bodyfat.html">Calculadora de Grasa</a></li>
                    <li><a href="upgrade.html">Premium</a></li>
                </ul>
            </nav>
            <div class="auth" id="authArea">
                <!-- El botón de login o el menú de usuario se inyectan por JS -->
            </div>
        </div>
    </header>
    <main>
        <section class="register-section">
            <div class="container" style="max-width:420px;">
                <div id="bodyfat-logged">
                    <h2 style="text-align:center;color:var(--accent);margin-bottom:18px;">Calculadora de Grasa Corporal</h2>
                    <form id="bodyfatForm" class="register-form" autocomplete="off">
                        <div class="form-row">
                            <label for="sexo">Sexo</label>
                            <select id="sexo" name="sexo" required>
                                <option value="">Seleccionar</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="peso">Peso (kg)</label>
                            <input id="peso" name="peso" type="number" step="0.1" min="1" placeholder="Ej: 70" required>
                        </div>
                        <div class="form-row">
                            <label for="altura">Altura (cm)</label>
                            <input id="altura" name="altura" type="number" step="0.1" min="1" placeholder="Ej: 175" required>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="button primary" style="width:100%;">Calcular</button>
                        </div>
                    </form>
                    <div id="resultado-grasa" style="margin-top:22px;text-align:center;font-size:1.15rem;"></div>
                </div>
                <div id="bodyfat-nologin" style="display:none;text-align:center;padding:40px 0;">
                    <h2 style="color:var(--accent);margin-bottom:18px;">Calculadora de Grasa Corporal</h2>
                    <p style="font-size:1.1rem;margin-bottom:18px;">Debes iniciar sesión para acceder a la calculadora.</p>
                    <a href="#" class="btn login-btn" id="loginBtnBodyfat">Iniciar sesión / Registrarse</a>
                </div>
            </div>
        </section>
    </main>
    <footer>
        <div class="container">
            <p>&copy; 2025 HealthUp. Todos los derechos reservados.</p>
        </div>
    </footer>
    <script src="js/auth.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/nav.js"></script>
    <script src="js/auth-modal.js"></script>
    <script>
        // Mostrar u ocultar calculadora según login
        function checkBodyfatAccess() {
            const user = window.Auth && window.Auth.getCurrentUser ? window.Auth.getCurrentUser() : null;
            const loggedDiv = document.getElementById('bodyfat-logged');
            const nologinDiv = document.getElementById('bodyfat-nologin');
            if (user) {
                loggedDiv.style.display = '';
                nologinDiv.style.display = 'none';
            } else {
                loggedDiv.style.display = 'none';
                nologinDiv.style.display = '';
                // Botón login funcional
                setTimeout(() => {
                    const btn = document.getElementById('loginBtnBodyfat');
                    if (btn) {
                        btn.onclick = function(e){ e.preventDefault(); document.getElementById('loginBtn').click(); };
                    }
                }, 100);
            }
        }
        document.addEventListener('DOMContentLoaded', checkBodyfatAccess);
        window.addEventListener('storage', checkBodyfatAccess);

        // Solo activa el cálculo si está logueado
        document.getElementById('bodyfatForm').onsubmit = function(e){
            e.preventDefault();
            const sexo = document.getElementById('sexo').value;
            const peso = parseFloat(document.getElementById('peso').value);
            const altura = parseFloat(document.getElementById('altura').value);

            if (!sexo || !peso || !altura) {
                document.getElementById('resultado-grasa').innerHTML = '<span style="color:#ff6f91;">Por favor, completa todos los campos.</span>';
                return;
            }

            // Cálculo de % grasa corporal estimado por IMC (Deurenberg formula)
            const imc = peso / Math.pow(altura/100, 2);
            const sexoNum = (sexo === "masculino") ? 1 : 0;
            let porcentaje = (1.20 * imc) - (10.8 * sexoNum) - 5.4;
            porcentaje = Math.max(2, Math.min(60, porcentaje));
            porcentaje = porcentaje.toFixed(1);

            let diagnostico = '';
            let recomendacion = '';
            if (sexo === "masculino") {
                if (porcentaje < 6) {
                    diagnostico = "Porcentaje de grasa corporal muy bajo.";
                    recomendacion = "Podrías estar por debajo del rango saludable. Considerá consultar a un profesional para evaluar tu estado nutricional.";
                } else if (porcentaje < 14) {
                    diagnostico = "Porcentaje de grasa corporal bajo (atleta).";
                    recomendacion = "Excelente estado físico. Mantené tus hábitos saludables.";
                } else if (porcentaje < 18) {
                    diagnostico = "Porcentaje de grasa corporal saludable.";
                    recomendacion = "Buen estado general. Seguí con una alimentación equilibrada y actividad física regular.";
                } else if (porcentaje < 25) {
                    diagnostico = "Porcentaje de grasa corporal promedio.";
                    recomendacion = "Estás dentro del rango normal, pero podés mejorar tu composición corporal con ejercicio y buena alimentación.";
                } else {
                    diagnostico = "Porcentaje de grasa corporal elevado.";
                    recomendacion = "Sería recomendable mejorar hábitos alimentarios y aumentar la actividad física. Consultá a un profesional para un plan personalizado.";
                }
            } else {
                if (porcentaje < 14) {
                    diagnostico = "Porcentaje de grasa corporal muy bajo.";
                    recomendacion = "Podrías estar por debajo del rango saludable. Considerá consultar a un profesional para evaluar tu estado nutricional.";
                } else if (porcentaje < 21) {
                    diagnostico = "Porcentaje de grasa corporal bajo (atleta).";
                    recomendacion = "Excelente estado físico. Mantené tus hábitos saludables.";
                } else if (porcentaje < 25) {
                    diagnostico = "Porcentaje de grasa corporal saludable.";
                    recomendacion = "Buen estado general. Seguí con una alimentación equilibrada y actividad física regular.";
                } else if (porcentaje < 32) {
                    diagnostico = "Porcentaje de grasa corporal promedio.";
                    recomendacion = "Estás dentro del rango normal, pero podés mejorar tu composición corporal con ejercicio y buena alimentación.";
                } else {
                    diagnostico = "Porcentaje de grasa corporal elevado.";
                    recomendacion = "Sería recomendable mejorar hábitos alimentarios y aumentar la actividad física. Consultá a un profesional para un plan personalizado.";
                }
            }

            document.getElementById('resultado-grasa').innerHTML =
                `<strong>Porcentaje estimado de grasa corporal: ${porcentaje}%</strong><br>
                <span style="color:var(--accent);font-weight:600;">${diagnostico}</span><br>
                <span style="color:#b6eec6;">${recomendacion}</span>`;
        };

        function renderUserMenu() {
            const authArea = document.getElementById('authArea');
            const user = window.Auth && window.Auth.getCurrentUser ? window.Auth.getCurrentUser() : null;
            if (user) {
                authArea.innerHTML = `
                    <div class="user-menu">
                        <button class="user-avatar" id="userAvatarBtn" aria-label="Perfil">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=181f1a&color=7bed9f&rounded=true&size=48" alt="Avatar" />
                        </button>
                        <div class="user-dropdown" id="userDropdown" style="display:none;">
                            <div class="user-info">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=181f1a&color=7bed9f&rounded=true&size=64" alt="Avatar" />
                                <div>
                                    <div class="user-name">${user.username}</div>
                                    <div class="user-email">${user.email}</div>
                                </div>
                            </div>
                            <a href="profile.html" class="user-profile-link">Ver perfil</a>
                            <button id="logoutBtn" class="user-logout">Cerrar sesión</button>
                        </div>
                    </div>
                `;
                const avatarBtn = document.getElementById('userAvatarBtn');
                const dropdown = document.getElementById('userDropdown');
                avatarBtn.onclick = function(e) {
                    e.stopPropagation();
                    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                };
                document.body.addEventListener('click', function() {
                    dropdown.style.display = 'none';
                });
                document.getElementById('logoutBtn').onclick = function() {
                    if (window.Auth && window.Auth.logout) {
                        window.Auth.logout();
                    }
                    location.reload();
                };
            } else {
                authArea.innerHTML = `<a href="#" class="btn login-btn" id="loginBtn">Iniciar sesión / Registrarse</a>`;
                setTimeout(() => {
                    const loginBtn = document.getElementById('loginBtn');
                    if (loginBtn) {
                        loginBtn.onclick = function(e) {
                            e.preventDefault();
                            const modal = document.getElementById('authModal');
                            if (modal) {
                                modal.style.display = 'flex';
                                document.body.style.overflow = 'hidden';
                            }
                        };
                    }
                }, 50);
            }
        }
        document.addEventListener('DOMContentLoaded', renderUserMenu);
        window.addEventListener('storage', renderUserMenu);
    </script>
</body>
</html>
