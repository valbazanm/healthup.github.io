<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil | HealthUp</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="site-header sticky-header">
        <div class="container header-inner">
            <a href="index.html" class="logo" style="display:flex;align-items:center;gap:10px;text-decoration:none;">
                <img src="img/logo.png" alt="HealthUp logo" style="height:38px;width:38px;vertical-align:middle;border-radius:8px;flex-shrink:0;">
                <div style="display:flex;flex-direction:column;line-height:1;">
                    <span style="font-weight:700;font-size:1.5rem;line-height:1;">HealthUp</span>
                    <span class="tagline" style="font-size:0.95rem;color:#7bed9f;line-height:1.2;">Tu salud, tu plan ‚Äî simple y accesible</span>
                </div>
            </a>
            <nav class="main-nav" aria-label="Men√∫ principal">
                <button class="nav-toggle" aria-label="Abrir men√∫">&#9776;</button>
                <ul>
                    <li><a href="about.html">Sobre Nosotros</a></li>
                    <li><a href="contact.html">Contacto</a></li>
                    <li><a href="meal-plans.html">Planes</a></li>
                    <li><a href="bodyfat.html">Calculadora de Grasa</a></li>
                    <li><a href="upgrade.html">Premium</a></li>
                </ul>
            </nav>
            <div class="auth" id="authArea">
                <!-- El bot√≥n de login o el men√∫ de usuario se inyectan por JS -->
            </div>
        </div>
    </header>
    <main>
        <section class="about-section container" id="profileSection">
            <h1 style="margin-bottom:32px;">Mi Perfil</h1>
            <div id="profileData"></div>
            
            <!-- Modal de cambiar contrase√±a -->
            <div id="changePasswordModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;">
                <div style="background:#070707;padding:40px;border-radius:12px;border:1px solid rgba(123,237,159,0.2);max-width:400px;width:90%;">
                    <h2 style="color:var(--accent);margin-bottom:24px;">Cambiar Contrase√±a</h2>
                    <div id="passwordError" style="color:#ff6b6b;margin-bottom:12px;display:none;padding:12px;background:rgba(255,107,107,0.1);border-radius:6px;"></div>
                    
                    <form id="changePasswordForm" style="display:flex;flex-direction:column;gap:16px;">
                        <div>
                            <label style="display:block;color:#b6eec6;margin-bottom:8px;font-weight:500;">Contrase√±a actual</label>
                            <input type="password" id="currentPassword" placeholder="Tu contrase√±a actual" style="width:100%;padding:12px;border-radius:6px;border:1px solid rgba(123,237,159,0.3);background:#0b0b0b;color:#b6eec6;font-size:1rem;" required>
                        </div>
                        <div>
                            <label style="display:block;color:#b6eec6;margin-bottom:8px;font-weight:500;">Nueva contrase√±a</label>
                            <input type="password" id="newPassword" placeholder="Nueva contrase√±a (m√≠nimo 4 caracteres)" style="width:100%;padding:12px;border-radius:6px;border:1px solid rgba(123,237,159,0.3);background:#0b0b0b;color:#b6eec6;font-size:1rem;" required>
                        </div>
                        <div>
                            <label style="display:block;color:#b6eec6;margin-bottom:8px;font-weight:500;">Confirmar nueva contrase√±a</label>
                            <input type="password" id="confirmPassword" placeholder="Confirma tu nueva contrase√±a" style="width:100%;padding:12px;border-radius:6px;border:1px solid rgba(123,237,159,0.3);background:#0b0b0b;color:#b6eec6;font-size:1rem;" required>
                        </div>
                        
                        <div style="display:flex;gap:12px;margin-top:24px;">
                            <button type="button" id="cancelPasswordBtn" style="flex:1;padding:12px;border-radius:6px;border:1px solid rgba(123,237,159,0.3);background:transparent;color:#b6eec6;font-weight:500;cursor:pointer;transition:all 0.3s;">Cancelar</button>
                            <button type="submit" style="flex:1;padding:12px;border-radius:6px;border:none;background:linear-gradient(135deg, #7bed9f, #5fb582);color:#070707;font-weight:600;cursor:pointer;transition:all 0.3s;">Cambiar</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        <section class="about-section container" id="nologinSection" style="display:none;text-align:center;padding:60px 0;">
            <h1 style="color:var(--accent);margin-bottom:24px;">Debes iniciar sesi√≥n para ver tu perfil</h1>
            <p style="font-size:1.1rem;margin-bottom:24px;">Inicia sesi√≥n o registrate para acceder a tu perfil personal.</p>
            <a href="index.html" style="display:inline-block;padding:12px 32px;border-radius:6px;background:linear-gradient(135deg, #7bed9f, #5fb582);color:#070707;text-decoration:none;font-weight:600;transition:all 0.3s;cursor:pointer;">Ir al inicio</a>
        </section>
    </main>
    <footer>
        <div class="container">
            <p>&copy; 2025 HealthUp. Todos los derechos reservados.</p>
        </div>
    </footer>
    <script src="js/auth.js"></script>
    <script src="js/scripts.js"></script>
    <script src="js/nav.js"></script>
    <script src="js/auth-modal.js"></script>
    <script>
    // Mostrar perfil si est√° logueado
    function showProfile() {
        const user = window.Auth && window.Auth.getCurrentUser ? window.Auth.getCurrentUser() : null;
        if (!user) {
            document.getElementById('profileSection').style.display = 'none';
            document.getElementById('nologinSection').style.display = '';
            return;
        }
        document.getElementById('profileSection').style.display = '';
        document.getElementById('nologinSection').style.display = 'none';
        document.getElementById('profileData').innerHTML = `
            <div style="background:#0b0b0b;padding:30px;border-radius:12px;border:1px solid rgba(123,237,159,0.2);margin-bottom:32px;">
                <div style="display:flex;align-items:center;margin-bottom:30px;gap:24px;">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=181f1a&color=7bed9f&rounded=true&size=120" alt="Avatar" style="border-radius:8px;width:120px;height:120px;flex-shrink:0;" />
                    <div>
                        <div style="font-size:1.8rem;font-weight:bold;color:#7bed9f;margin-bottom:8px;">${user.username}</div>
                        <div style="color:#b6eec6;margin-bottom:12px;font-size:1rem;">${user.email}</div>
                        <div style="color:#888;font-size:0.95rem;">Miembro desde ${new Date(user.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    </div>
                </div>
                <hr style="border:none;border-top:1px solid rgba(123,237,159,0.15);margin:30px 0;" />
                <div style="margin-top:30px;">
                    <strong style="color:var(--accent);display:block;margin-bottom:16px;font-size:1.1rem;">Informaci√≥n de cuenta</strong>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                        <div>
                            <p style="color:#888;font-size:0.9rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Usuario</p>
                            <p style="color:#b6eec6;font-size:1.05rem;margin:0;">${user.username}</p>
                        </div>
                        <div>
                            <p style="color:#888;font-size:0.9rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Email</p>
                            <p style="color:#b6eec6;font-size:1.05rem;margin:0;">${user.email}</p>
                        </div>
                        <div>
                            <p style="color:#888;font-size:0.9rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Plan</p>
                            <p id="profilePlan" style="color:#7bed9f;font-size:1.05rem;margin:0;font-weight:500;">${user.plan && user.plan === 'pago' ? 'Premium' : 'Gratuito'}</p>
                        </div>
                        <div>
                            <p style="color:#888;font-size:0.9rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px;">Estado</p>
                            <p style="color:#7bed9f;font-size:1.05rem;margin:0;font-weight:500;">Activo</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <a href="index.html" style="flex:1;min-width:200px;padding:14px 24px;border-radius:8px;background:linear-gradient(135deg, #2a4a3a, #1a3a2a);color:#7bed9f;text-decoration:none;font-weight:600;text-align:center;border:1px solid rgba(123,237,159,0.3);transition:all 0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <span>‚Üê</span> Volver al inicio
                </a>
                ${user.plan === 'pago' ? `
                <a href="receipt.html" style="flex:1;min-width:200px;padding:14px 24px;border-radius:8px;background:linear-gradient(135deg,#2a9aef,#1e7bd6);color:#fff;text-decoration:none;font-weight:600;text-align:center;border:1px solid rgba(30,123,214,0.2);transition:all 0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">üìÑ Ver pago</a>
                <button id="cancelSubscriptionBtn" style="flex:1;min-width:200px;padding:14px 24px;border-radius:8px;background:linear-gradient(135deg,#ef4a4a,#d63a3a);color:#fff;text-decoration:none;font-weight:600;text-align:center;border:1px solid rgba(255,107,107,0.2);transition:all 0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">‚úñ Cancelar suscripci√≥n</button>
                ` : ''}
                <button id="changePasswordBtn" style="flex:1;min-width:200px;padding:14px 24px;border-radius:8px;background:linear-gradient(135deg, #4a3a2a, #3a2a1a);color:#f0b87f;text-decoration:none;font-weight:600;text-align:center;border:1px solid rgba(240,184,127,0.3);transition:all 0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <span>üîë</span> Cambiar contrase√±a
                </button>
                <button id="logoutBtn" style="flex:1;min-width:200px;padding:14px 24px;border-radius:8px;background:linear-gradient(135deg, #4a2a2a, #3a1a1a);color:#ff9999;text-decoration:none;font-weight:600;text-align:center;border:1px solid rgba(255,107,107,0.3);transition:all 0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <span>üö™</span> Cerrar sesi√≥n
                </button>
            </div>
        `;
        
        // Eventos de los botones
        document.getElementById('changePasswordBtn').onclick = function() {
            document.getElementById('changePasswordModal').style.display = 'flex';
        };
        
        document.getElementById('logoutBtn').onclick = function() {
            if (window.Auth && window.Auth.logout) {
                window.Auth.logout();
            }
            location.reload();
        };
        // Si existe el boton de cancelar suscripci√≥n, enlazar evento
        const cancelBtn = document.getElementById('cancelSubscriptionBtn');
        if (cancelBtn) {
            cancelBtn.onclick = function() {
                if (!confirm('¬øEst√°s seguro que quer√©s cancelar tu suscripci√≥n Premium?')) return;
                const res = window.Auth.setUserPlan(user.username, 'gratis');
                if (res && res.success) {
                    alert('Tu suscripci√≥n fue cancelada. Tu cuenta ahora es Gratuita.');
                    location.reload();
                } else {
                    alert('No se pudo cancelar la suscripci√≥n. Intenta nuevamente.');
                }
            };
        }
        // A√±adir acceso r√°pido a configuraci√≥n IA si es premium
        const aiConfigBtn = document.getElementById('aiConfigBtn');
        if (!aiConfigBtn && user.plan === 'pago') {
            const wrapper = document.querySelector('#profileData > div + div') || document.querySelector('#profileData');
            // Crear bot√≥n y a√±adirlo antes del changePasswordBtn
            const btn = document.createElement('a');
            btn.href = 'ai.html';
            btn.id = 'aiConfigBtn';
            btn.style.cssText = 'flex:1;min-width:200px;padding:14px 24px;border-radius:8px;background:linear-gradient(135deg,#7a4fe6,#5b3fd1);color:#fff;text-decoration:none;font-weight:600;text-align:center;border:1px solid rgba(91,63,209,0.2);transition:all 0.3s;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;';
            btn.innerHTML = 'ü§ñ Acceder a IA';
            const actions = document.querySelector('#profileData div[style*="display:flex;gap:12px;"]');
            if (actions) actions.insertBefore(btn, actions.children[1] || actions.firstChild);
        }
    }
    document.addEventListener('DOMContentLoaded', showProfile);
    window.addEventListener('storage', showProfile);
    </script>
    
    <script>
    // Manejo del modal de cambiar contrase√±a
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('changePasswordModal');
        const form = document.getElementById('changePasswordForm');
        const cancelBtn = document.getElementById('cancelPasswordBtn');
        const errorDiv = document.getElementById('passwordError');
        
        // Cerrar modal
        cancelBtn.onclick = function() {
            modal.style.display = 'none';
            form.reset();
            errorDiv.style.display = 'none';
        };
        
        // Cerrar modal al hacer click fuera
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
                form.reset();
                errorDiv.style.display = 'none';
            }
        };
        
        // Manejar submit del formulario
        form.onsubmit = function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validaciones b√°sicas
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'Por favor completa todos los campos';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 4) {
                errorDiv.textContent = 'La nueva contrase√±a debe tener al menos 4 caracteres';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Las contrase√±as no coinciden';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (currentPassword === newPassword) {
                errorDiv.textContent = 'La nueva contrase√±a debe ser diferente a la actual';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Cambiar la contrase√±a usando el m√≥dulo Auth
            const user = window.Auth && window.Auth.getCurrentUser ? window.Auth.getCurrentUser() : null;
            if (!user) {
                errorDiv.textContent = 'Usuario no encontrado';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Usar la funci√≥n changePassword del m√≥dulo Auth
            const result = window.Auth.changePassword(user.username, currentPassword, newPassword);
            
            if (!result.success) {
                errorDiv.textContent = result.error || 'Error al cambiar la contrase√±a';
                errorDiv.style.display = 'block';
                return;
            }
            
            // √âxito
            alert('‚úÖ Contrase√±a cambiada correctamente');
            modal.style.display = 'none';
            form.reset();
            errorDiv.style.display = 'none';
        };
    });
    </script>
    <script>
    function renderUserMenu() {
        const authArea = document.getElementById('authArea');
        const user = window.Auth && window.Auth.getCurrentUser ? window.Auth.getCurrentUser() : null;
        if (user) {
            authArea.innerHTML = `
                <div class="user-menu">
                    <button class="user-avatar" id="userAvatarBtn" aria-label="Perfil">
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=181f1a&color=7bed9f&rounded=true&size=48" alt="Avatar" />
                    </button>
                    <div class="user-dropdown" id="userDropdown" style="display:none;">
                        <div class="user-info">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=181f1a&color=7bed9f&rounded=true&size=64" alt="Avatar" />
                            <div>
                                <div class="user-name">${user.username}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                        <a href="profile.html" class="user-profile-link">Ver perfil</a>
                        <button id="logoutBtn2" class="user-logout">Cerrar sesi√≥n</button>
                    </div>
                </div>
            `;
            const avatarBtn = document.getElementById('userAvatarBtn');
            const dropdown = document.getElementById('userDropdown');
            avatarBtn.onclick = function(e) {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            };
            document.body.addEventListener('click', function() {
                dropdown.style.display = 'none';
            });
            const logoutBtn2 = document.getElementById('logoutBtn2');
            if (logoutBtn2) {
                logoutBtn2.onclick = function() {
                    if (window.Auth && window.Auth.logout) {
                        window.Auth.logout();
                    }
                    location.reload();
                };
            }
        } else {
            authArea.innerHTML = `<a href="#" class="btn login-btn" id="loginBtn">Iniciar sesi√≥n / Registrarse</a>`;
            setTimeout(() => {
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.onclick = function(e) {
                        e.preventDefault();
                        const modal = document.getElementById('authModal');
                        if (modal) {
                            modal.style.display = 'flex';
                            document.body.style.overflow = 'hidden';
                        }
                    };
                }
            }, 50);
        }
    }
    document.addEventListener('DOMContentLoaded', renderUserMenu);
    window.addEventListener('storage', renderUserMenu);
    </script>
</body>
</html>